---
title: "IPTW_JiyeUpdated"
author: "JiyeKwon"
date: "12/13/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(questionr)
library(geepack)
library(broom)
library(CMAverse)
library("geepack")
library("broom")
library("dplyr")
library("MASS")
library("lme4")
library("glmmTMB")
library("gamm4")
```

### Pre-processing  
```{r}
#load in dataset 
#aggregate_pm_census_cdc_test_beds<- readRDS("./final project/aggregate_pm_census_cdc_test_beds_P6.RDS")
```

## Original model  

```{r, include=FALSE}
mode.nb.random.off.main = glmmTMB(Deaths ~ mean_pm25 + factor(q_popdensity)
                                    + scale(poverty) + scale(log(medianhousevalue))
                                    + scale(log(medhouseholdincome)) + scale(pct_owner_occ) 
                                    + scale(education) 
                                    + scale(pct_blk) + scale(hispanic)
                                    + scale(older_pecent) + scale(prime_pecent) + scale(mid_pecent) 
                                    + scale(date_since_social) + scale(date_since)
                                    + scale(beds/population) 
                                    + scale(obese) + scale(smoke)
                                    + scale(mean_summer_temp) + scale(mean_winter_temp) + scale(mean_summer_rm) + scale(mean_winter_rm)
                                    + (1|state)
                                    + offset(log(population)), family="nbinom2", control=glmmTMBControl(parallel=5), data = aggregate_pm_census_cdc_test_beds)
summary(mode.nb.random.off.main)
```

## PS control by weighting
#### IPW for treatment (IPTW): inverse probability of treatment weighting (IPTW)
Reference: Lecture 6, lab 5  

model PS = Pr(E =1 | covs)
additional covs = face_masks (binary), Tests_per_100K (continuous) + perc_unins (continuous) 
```{r}
# Create the denominator of IPW for treatment (IPTW)
# For the treated, PS is the denominator of the weight.  

fitps_E <- glm(pm25 ~ face_masks + Tests_per_100K + perc_unins 
               +q_popdensity+ poverty 
               + log(medianhousevalue)
               + log(medhouseholdincome)
               +pct_owner_occ
               + education
               + pct_blk + hispanic
               + older_pecent + prime_pecent + mid_pecent
                                    + date_since_social + date_since
                                    + beds/population
                                    + obese + smoke
                                    + mean_summer_temp + 
                 mean_winter_temp+ mean_summer_rm +mean_winter_rm+ 
                 offset(log(population)), #+ (1|as.factor(state)), # do we take random effects in to account in IPTW PS ..? Since it is longitudinal data?
               data = aggregate_pm_census_cdc_test_beds,
                                             family = binomial())
summary(fitps_E)
aggregate_pm_census_cdc_test_beds$ps <- predict(fitps_E,aggregate_pm_census_cdc_test_beds, type="response")

# Create the numerator of IPTW for stabilized weight
# model pn_e = Pr(E=1) in this population

fitpn_E <- glm(pm25 ~ 1, data=aggregate_pm_census_cdc_test_beds,family=binomial())
summary(fitpn_E)
aggregate_pm_census_cdc_test_beds$pn_E <- predict(fitpn_E, aggregate_pm_census_cdc_test_beds, type="response")
#table(aggregate_pm_census_cdc_test_beds$pm25)/nrow(aggregate_pm_census_cdc_test_beds)


# Calculate the stabilized weights for the exposed/treated and the unexposed/untreated
aggregate_pm_census_cdc_test_beds <- aggregate_pm_census_cdc_test_beds %>% mutate(
  sw_e = ifelse(pm25 == 1,
                yes = pn_E/ps,
                no = (1-pn_E)/(1-ps)),
  uw_e = ifelse(pm25 == 1,
                yes = 1/ps,
                no = 1/(1-ps)))

# Mean values of unstabilized and stabilized IPW
summary(aggregate_pm_census_cdc_test_beds$uw_e) #mean =~ 27.8
summary(aggregate_pm_census_cdc_test_beds$sw_e) #mean =~ 13.9
```

## Marginal structural model with IPTW estimating the marginal mean differences for the exposure/treatment on the outcome

```{r}
fitsw <- glm(Deaths ~ pm25,data=aggregate_pm_census_cdc_test_beds,
             weights = sw_e, family = gaussian(link = "identity"))
summary(fitsw)
cbind(beta = coef(fitsw), confint(fitsw))
#Total effect using stablized weight: E            1.20  -5.07   7.48


fituw <- glm(Deaths ~ pm25,data=aggregate_pm_census_cdc_test_beds,
             weights = uw_e, family = gaussian(link = "identity"))
summary(fituw)
cbind(beta = coef(fituw), confint(fituw))
#Total effect using unstablized weight: E            1.205  -5.08   7.499
```

```{r, ignore for now}
#### Robust standard error estimators # Outcome regression with IPTW
msm.sw_s <- geeglm(
  Deaths ~ pm25 + face_masks + Tests_per_100K + perc_unins,
  data = aggregate_pm_census_cdc_test_beds,
  weights = sw_e,
  id = NAME.x,
  corstr = "independence"
)
summary(msm.sw_s)
broom::tidy(x = msm.sw_s, conf.int = TRUE)
#stabilized weight: E 34.0, 95% CI: 30.6, 37.4

```

### Controlled direct effect? 
```{r}

```

